<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ale">
<title>Comparison between ALEPlot and ale packages • ale</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Comparison between ALEPlot and ale packages">
<meta property="og:description" content="ale">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ale</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.20240131</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/ale-ALEPlot.html">Comparison between ALEPlot and ale packages</a>
    <a class="dropdown-item" href="../articles/ale-intro.html">Introduction to the ale package</a>
    <a class="dropdown-item" href="../articles/ale-small-datasets.html">Analyzing small datasets (fewer than 2000 rows) with ALE</a>
    <a class="dropdown-item" href="../articles/ale-statistics.html">ALE-based statistics for statistical inference and effect sizes</a>
    <a class="dropdown-item" href="../articles/ale-x-datatypes.html">ale function handling of various datatypes for x</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Tripartio/ale/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Comparison between ALEPlot and ale packages</h1>
                        <h4 data-toc-skip class="author">Chitu
Okoli</h4>
            
            <h4 data-toc-skip class="date">January 10, 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Tripartio/ale/blob/HEAD/vignettes/ale-ALEPlot.Rmd" class="external-link"><code>vignettes/ale-ALEPlot.Rmd</code></a></small>
      <div class="d-none name"><code>ale-ALEPlot.Rmd</code></div>
    </div>

    
    
<p>The <a href="https://CRAN.r-project.org/package=ALEPlot" class="external-link"><code>{ALEPlot}</code>
package</a> is the reference implementation of the brilliant idea of <a href="https://www.doi.org/10.1111/rssb.12377" class="external-link">accumulated local effects
(ALE) by Daniel Apley and Jingyu Zhu</a>. However, it has not been
updated since 2018. The <a href="ale-intro.html" title="Introduction to the ale package"><code>{ale}</code> package</a>
attempts to rewrite and extend the original base work.</p>
<p>In developing the <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> package, we must ensure that we
correctly implement the original ALE algorithm while extending it.
Indeed, some permanent unit tests call <code>{ALEPlot}</code> to make
sure that <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> provides identical results for identical
inputs. We thought that presenting some of these comparisons as a
vignette might be helpful. We focus here on the <a href="https://CRAN.r-project.org/package=ALEPlot/vignettes/AccumulatedLocalEffectPlot.pdf" class="external-link">examples
from the <code>{ALEPlot}</code> package</a> so that results are directly
comparable.</p>
<p>Other than its <a href="ale-statistics.html">extensions for ALE-based
statistics</a>, here are some of the main points in which
<a href="https://github.com/Tripartio/ale" class="external-link">ale</a> differs from <code>{ALEPlot}</code> where it provides
otherwise similar functionality:</p>
<ul>
<li>It uses <code>ggplot2</code> instead of base R graphics. We consider
<code>ggplot2</code> to be a more modern and versatile graphics
system.</li>
<li>It saves plots as ggplot objects to a “plots” element of the return
value; it does not automatically print the plot to the screen. As we
show, this lets the user manipulate the plots more flexibly.</li>
<li>In the plot, the Y outcome variable is displayed by default on its
full absolute scale, centred on the median or mean, not on a scale
relative to zero. (This option can be controlled with the
<code>relative_y</code> argument, as we demonstrate.) We believe that
such plots more easily interpretable.</li>
<li>In addition, there are numerous design choices to simply the
function interface based on <a href="https://www.tidyverse.org/" class="external-link">tidyverse</a> design principles.</li>
</ul>
<p>One notable difference between the two packages is that the
<a href="https://github.com/Tripartio/ale" class="external-link">ale</a> package does not and will not implement partial
dependency plots (PDP). The package is focused exclusively on
accumulated local effects (ALE); users who need PDPs may use
<code>{ALEPlot}</code> or other implementations.</p>
<p>In each section here, we cover an example from <code>{ALEPlot}</code>
and then reimplement it with <code>ale</code>.</p>
<p>We begin by loading the necessary libraries.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
<div class="section level2">
<h2 id="simulated-data-with-numeric-outcomes-aleplot-example-2">Simulated data with numeric outcomes (ALEPlot Example 2)<a class="anchor" aria-label="anchor" href="#simulated-data-with-numeric-outcomes-aleplot-example-2"></a>
</h2>
<p>We begin with the second code example directly from the
<code>{ALEPlot}</code> package. (We skip the first example because it is
a subset of the second, simply without interactions.) Here is the code
from the example to create a simulated dataset and train a neural
network on it:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## R code for Example 2</span></span>
<span><span class="co">## Load relevant packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ALEPlot</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">nnet</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Generate some data and fit a neural network supervised learning model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>  <span class="co"># not in the original, but added for reproducibility</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fl">5000</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fl">4</span><span class="op">*</span><span class="va">x1</span> <span class="op">+</span> <span class="fl">3.87</span><span class="op">*</span><span class="va">x2</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">2.97</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span><span class="op">+</span><span class="fl">10</span><span class="op">*</span><span class="va">x3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span><span class="op">+</span><span class="fl">10</span><span class="op">*</span><span class="va">x3</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fl">13.86</span><span class="op">*</span><span class="op">(</span><span class="va">x1</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">x2</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">DAT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">x1</span>, <span class="va">x2</span>, <span class="va">x3</span>, <span class="va">x4</span><span class="op">)</span></span>
<span><span class="va">nnet.DAT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nnet/man/nnet.html" class="external-link">nnet</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">DAT</span>, linout <span class="op">=</span> <span class="cn">T</span>, skip <span class="op">=</span> <span class="cn">F</span>, size <span class="op">=</span> <span class="fl">6</span>,</span>
<span>decay <span class="op">=</span> <span class="fl">0.1</span>, maxit <span class="op">=</span> <span class="fl">1000</span>, trace <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p>For the demonstration, <code>x1</code> has a linear relationship with
<code>y</code>, <code>x2</code> and <code>x3</code> have non-linear
relationships, and <code>x4</code> is a random variable with no
relationship with <code>y</code>. <code>x1</code> and <code>x2</code>
interact with each other in their relationship with <code>y</code>.</p>
<div class="section level3">
<h3 id="aleplot-code">ALEPlot code<a class="anchor" aria-label="anchor" href="#aleplot-code"></a>
</h3>
<p>To create ALE data and plots, <code>{ALEPlot}</code> requires the
creation of a custom prediction function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Define the predictive function</span></span>
<span><span class="va">yhat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X.model</span>, <span class="va">newdata</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">X.model</span>, <span class="va">newdata</span>,</span>
<span>type <span class="op">=</span> <span class="st">"raw"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now the <code>{ALEPlot}</code> function can be called to create the
ALE data and plot it. The function returns a specially formatted list
with the ALE data; it can be saved for subsequent custom plotting.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Calculate and plot the ALE main effects of x1, x2, x3, and x4</span></span>
<span><span class="va">ALE.1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">DAT</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="va">nnet.DAT</span>, pred.fun <span class="op">=</span> <span class="va">yhat</span>, J <span class="op">=</span> <span class="fl">1</span>, K <span class="op">=</span> <span class="fl">500</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ALEPlot%20nnet%20one-way-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ALE.2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">DAT</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="va">nnet.DAT</span>, pred.fun <span class="op">=</span> <span class="va">yhat</span>, J <span class="op">=</span> <span class="fl">2</span>, K <span class="op">=</span> <span class="fl">500</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ALEPlot%20nnet%20one-way-2.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ALE.3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">DAT</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="va">nnet.DAT</span>, pred.fun <span class="op">=</span> <span class="va">yhat</span>, J <span class="op">=</span> <span class="fl">3</span>, K <span class="op">=</span> <span class="fl">500</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ALEPlot%20nnet%20one-way-3.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ALE.4</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">DAT</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="va">nnet.DAT</span>, pred.fun <span class="op">=</span> <span class="va">yhat</span>, J <span class="op">=</span> <span class="fl">4</span>, K <span class="op">=</span> <span class="fl">500</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ALEPlot%20nnet%20one-way-4.png" width="700"></p>
<p>In the <code>{ALEPlot}</code> implementation, calling the function
automatically prints a plot. While this provides some convenience if
that is what the user wants, it is not so convenient if the user does
not want to print a plot at the very point of ALE creation. It is
particularly inconvenient for script building. Although it is possible
to configure R to suspend graphic output before the
<code>{ALEPlot}</code> is called and then restart it after the function
call, this is not so straightforward—the function itself does not give
any option to control this behaviour.</p>
<p>ALE interactions can also be calculated and plotted:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Calculate and plot the ALE second-order effects of {x1, x2} and {x1, x4}</span></span>
<span><span class="va">ALE.12</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">DAT</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="va">nnet.DAT</span>, pred.fun <span class="op">=</span> <span class="va">yhat</span>, J <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, K <span class="op">=</span> <span class="fl">100</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ALEPlot%20nnet%20ixn-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ALE.14</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">DAT</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="va">nnet.DAT</span>, pred.fun <span class="op">=</span> <span class="va">yhat</span>, J <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span>, K <span class="op">=</span> <span class="fl">100</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ALEPlot%20nnet%20ixn-2.png" width="700"></p>
<p>If the output of the <code>{ALEPlot}</code> has been saved to
variables, then its contents can be plotted with finer user control
using the generic R <code>plot</code> method:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Manually plot the ALE main effects on the same scale for easier comparison</span></span>
<span><span class="co">## of the relative importance of the four predictor variables</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ALE.1</span><span class="op">$</span><span class="va">x.values</span>, <span class="va">ALE.1</span><span class="op">$</span><span class="va">f.values</span>, type<span class="op">=</span><span class="st">"l"</span>, xlab<span class="op">=</span><span class="st">"x1"</span>,</span>
<span>ylab<span class="op">=</span><span class="st">"ALE_main_x1"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"(a)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ALE.2</span><span class="op">$</span><span class="va">x.values</span>, <span class="va">ALE.2</span><span class="op">$</span><span class="va">f.values</span>, type<span class="op">=</span><span class="st">"l"</span>, xlab<span class="op">=</span><span class="st">"x2"</span>,</span>
<span>ylab<span class="op">=</span><span class="st">"ALE_main_x2"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"(b)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ALE.3</span><span class="op">$</span><span class="va">x.values</span>, <span class="va">ALE.3</span><span class="op">$</span><span class="va">f.values</span>, type<span class="op">=</span><span class="st">"l"</span>, xlab<span class="op">=</span><span class="st">"x3"</span>,</span>
<span>ylab<span class="op">=</span><span class="st">"ALE_main_x3"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"(c)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ALE.4</span><span class="op">$</span><span class="va">x.values</span>, <span class="va">ALE.4</span><span class="op">$</span><span class="va">f.values</span>, type<span class="op">=</span><span class="st">"l"</span>, xlab<span class="op">=</span><span class="st">"x4"</span>,</span>
<span>ylab<span class="op">=</span><span class="st">"ALE_main_x4"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"(d)"</span><span class="op">)</span></span>
<span><span class="co">## Manually plot the ALE second-order effects of {x1, x2} and {x1, x4}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">ALE.12</span><span class="op">$</span><span class="va">x.values</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ALE.12</span><span class="op">$</span><span class="va">x.values</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">ALE.12</span><span class="op">$</span><span class="va">f.values</span>, xlab <span class="op">=</span> <span class="st">"x1"</span>,</span>
<span>ylab <span class="op">=</span> <span class="st">"x2"</span>, main <span class="op">=</span> <span class="st">"(e)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/contour.html" class="external-link">contour</a></span><span class="op">(</span><span class="va">ALE.12</span><span class="op">$</span><span class="va">x.values</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ALE.12</span><span class="op">$</span><span class="va">x.values</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">ALE.12</span><span class="op">$</span><span class="va">f.values</span>, add<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>drawlabels<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">ALE.14</span><span class="op">$</span><span class="va">x.values</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ALE.14</span><span class="op">$</span><span class="va">x.values</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">ALE.14</span><span class="op">$</span><span class="va">f.values</span>, xlab <span class="op">=</span> <span class="st">"x1"</span>,</span>
<span>ylab <span class="op">=</span> <span class="st">"x4"</span>, main <span class="op">=</span> <span class="st">"(f)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/contour.html" class="external-link">contour</a></span><span class="op">(</span><span class="va">ALE.14</span><span class="op">$</span><span class="va">x.values</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ALE.14</span><span class="op">$</span><span class="va">x.values</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">ALE.14</span><span class="op">$</span><span class="va">f.values</span>, add<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>drawlabels<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ALEPlot%20nnet%20organized%20plots-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="ale-package-equivalent">
<code>{ale}</code> package equivalent<a class="anchor" aria-label="anchor" href="#ale-package-equivalent"></a>
</h3>
<p>Now we demonstrate the same functionality with the <a href="https://github.com/Tripartio/ale" class="external-link">ale</a>
package. We will work with the same model on the same data, so we will
not create them again.</p>
<p>To create the model, we invoke the <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> which returns a
list with various ALE elements.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Tripartio/ale" class="external-link">ale</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: ggplot2</span></span>
<span></span>
<span><span class="va">nn_ale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ale.html">ale</a></span><span class="op">(</span></span>
<span>  <span class="va">DAT</span>, <span class="va">nnet.DAT</span>, pred_type <span class="op">=</span> <span class="st">"raw"</span>,</span>
<span>  model_packages <span class="op">=</span> <span class="st">'nnet'</span>  <span class="co"># required for parallel processing</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Info: No global progress bars were found; the cli handler has been enabled. This activation only lasts for one R session; see help(ale) for how to</span></span>
<span><span class="co">#&gt;         permanently configure the progress bar settings.</span></span></code></pre></div>
<p>Here are some notable differences compared to
<code>ALEPlot</code>:</p>
<ul>
<li>In tidyverse style, the first element is the data and the second is
the model.</li>
<li>Unlike <code>{ALEPlot}</code> that functions on only one variable at
a time, <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> generates ALE data for multiple variables in
a dataset at once. By default, it generates ALE elements for all the
predictor variables in the dataset that it is given; the user can
specify a single variable or any subset of variables. We will cover more
details in another vignette, but for our purposes here, we note the
<code>data</code> element that returns a list of the ALE data for each
variable and the <code>plots</code> element returns a list of
<code>ggplot</code> plots.</li>
<li>
<a href="https://github.com/Tripartio/ale" class="external-link">ale</a> creates a default generic predict function that
matches most standard R models. When the prediction type is not the
default “response”, as in our case, the user can set the desired type
with the <code>pred_type</code> argument. However, for more complex or
non-standard prediction functions, <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> supports custom
functions with the <code>pred_fun</code> argument.</li>
</ul>
<p>Since the plots are saved as a list, they can easily be printed out
all at once:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># , fig.asp=3 is OK</span></span>
<span><span class="co"># Print plots</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">nn_ale</span><span class="op">$</span><span class="va">plots</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ale%20nnet%20one-way%20plots-1.png" width="336"></p>
<p>The <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> package plots have various features that
enhance interpretability:</p>
<ul>
<li>The outcome y is displayed on its full original scale.</li>
<li>A median band that shows the middle 5 percentile of the y values is
displayed. The idea is that any ALE values outside this band are at
least somewhat significant.</li>
<li>Similarly, there are 25% and 75% percentile markers to show the
middle 50% of the y values. Any ALE y value beyond these bands indicates
that the x variable is so strong that it alone at the values indicated
can shift the y value by that much.</li>
<li>Rug plots indicate the distribution of the data so that outliers are
not over-interpreted.</li>
</ul>
<p>It might not be clear that the previous plots display exactly the
same data as those shown above from <code>ALEPlot</code>. To make the
comparison clearer, we can recalculate the ALEs on a zero-centred
scale:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Zero-centred ALE</span></span>
<span><span class="va">nn_ale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ale.html">ale</a></span><span class="op">(</span></span>
<span>  <span class="va">DAT</span>, <span class="va">nnet.DAT</span>, pred_type <span class="op">=</span> <span class="st">"raw"</span>, relative_y <span class="op">=</span> <span class="st">'zero'</span>,</span>
<span>  model_packages <span class="op">=</span> <span class="st">'nnet'</span>  <span class="co"># required for parallel processing</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Info: No global progress bars were found; the cli handler has been enabled. This activation only lasts for one R session; see help(ale) for how to</span></span>
<span><span class="co">#&gt;         permanently configure the progress bar settings.</span></span>
<span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">nn_ale</span><span class="op">$</span><span class="va">plots</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ale%20nnet%20one-way%20zeroed-1.png" width="672"></p>
<p>With these zero-centred plots, the full range of y values and the rug
plots give some context that aids interpretation. (If the rugs look
slightly different, it is because they are randomly jittered to avoid
overplotting.)</p>
<p>The <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> also produces interaction plots. Unlike
<code>ALEPlot</code>, it does so with a separate dedicated function,
<code><a href="../reference/ale_ixn.html">ale_ixn()</a></code>. By default, it calculates all possible two-way
interactions between all variables in the data.</p>
<p>Because the variables interact with each other, the output data
structure is a two-layer list, so the print code is slightly more
complicated. However, the sample code we provide here using functions
from the <code>purrr</code> package for iterating through lists and
<code>gridExtra</code> package for arranging plots are reusable in any
application.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create and plot interactions</span></span>
<span><span class="va">nn_ale_ixn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ale_ixn.html">ale_ixn</a></span><span class="op">(</span></span>
<span>  <span class="va">DAT</span>, <span class="va">nnet.DAT</span>, pred_type <span class="op">=</span> <span class="st">"raw"</span>,</span>
<span>  model_packages <span class="op">=</span> <span class="st">'nnet'</span>  <span class="co"># required for parallel processing</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Info: No global progress bars were found; the cli handler has been enabled. This activation only lasts for one R session; see help(ale) for how to</span></span>
<span><span class="co">#&gt;         permanently configure the progress bar settings.</span></span>
<span></span>
<span><span class="co"># Print plots</span></span>
<span><span class="va">nn_ale_ixn</span><span class="op">$</span><span class="va">plots</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">walk</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">.x1</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># extract list of x1 ALE outputs</span></span>
<span>    <span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">.x1</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>  <span class="co"># plot all x1 plots</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ale%20nnet%20ixn-1.png" width="672"><img src="ale-ALEPlot_files/figure-html/ale%20nnet%20ixn-2.png" width="672"><img src="ale-ALEPlot_files/figure-html/ale%20nnet%20ixn-3.png" width="672"></p>
<p>These interaction plots are heat maps that indicate the interaction
regions that are above or below the average value of y with colours.
Grey indicates no meaningful interaction; blue indicates a positive
interaction effect; red indicates a negative effect. We find these
easier to interpret than the contour maps from <code>ALEPlot</code>,
especially since the colours in each plot are on the same scale and so
the plots are directly comparable with each other.</p>
<p>The range of outcome (y) values is divided into quantiles, deciles by
default. However, the middle quantiles are modified. Rather than showing
the middle 10% or 20% of values, it is much narrow: it shows the middle
5%. (This value is based on the notion of alpha of 0.05 for confidence
intervals; it can be customized with the <code>median_band</code>
argument.)</p>
<p>The legend shows the midpoint y value of each quantile, which is
usually the mean of the boundaries of the quantile. The exception is the
special middle quantile, whose displayed midpoint value is the median of
the entire dataset.</p>
<p>The interpretation of these interaction plots is that in any given
region, the interaction between x1 and x2 increases (blue) or decreases
(red) y by the amount indicated over and above the separate individual
direct effects of x1 and x2 shown in the one-way ALE plots above. It is
<strong>not</strong> an indication of the total effect of both variables
together but rather of the additional effect of their interaction-
beyond their individual effects. Thus, only the x1-x2 interaction shows
any effect. For the interactions with x3, even though x3 indeed has a
strong effect on y as we see in the one-way ALE plot above, it has no
additional effect in interaction with the other variables, and so its
interaction plots are entirely grey.</p>
</div>
</div>
<div class="section level2">
<h2 id="real-data-with-binary-outcomes-aleplot-example-3">Real data with binary outcomes (ALEPlot Example 3)<a class="anchor" aria-label="anchor" href="#real-data-with-binary-outcomes-aleplot-example-3"></a>
</h2>
<p>The next code example from the <code>{ALEPlot}</code> package
analyzes a real dataset with a binary outcome variable. Whereas the
<code>{ALEPlot}</code> has the user load a CSV file that might not be
readily available, we make that dataset available as the census dataset.
We load it here with the adjustments necessary to run the
<code>{ALEPlot}</code> example.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## R code for Example 3</span></span>
<span><span class="co">## Load relevant packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ALEPlot</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gbm-developers/gbm" class="external-link">gbm</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loaded gbm 2.1.9</span></span>
<span><span class="co">#&gt; This version of gbm is no longer under development. Consider transitioning to gbm3, https://github.com/gbm-developers/gbm3</span></span>
<span></span>
<span><span class="co">## Read data and fit a boosted tree supervised learning model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">census</span>, package <span class="op">=</span> <span class="st">'ale'</span><span class="op">)</span>  <span class="co"># load ale package version of the data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span>  </span>
<span>  <span class="va">census</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>   <span class="co"># ALEPlot is not compatible with the tibble format</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">age</span><span class="op">:</span><span class="va">native_country</span>, <span class="va">higher_income</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="co"># Rearrange columns to match ALEPlot order</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p>Although gradient boosted trees generally perform quite well, they
are rather slow. Rather than having you wait for it to run, the code
here downloads a pretrained GBM model. However, the code used to
generate it is provided in comments so that you can see it and run it
yourself if you want to. Note that the model calls is based on
<code>data[,-c(3,4)]</code>, which drops the third and fourth variables
(<code>fnlwgt</code> and <code>education</code>, respectively).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># To generate the code, uncomment the following lines.</span></span>
<span><span class="co"># But it is slow, so this vignette loads a pre-created model object.</span></span>
<span><span class="co"># set.seed(0)</span></span>
<span><span class="co"># gbm.data &lt;- gbm(higher_income ~ ., data= data[,-c(3,4)],</span></span>
<span><span class="co">#                 distribution = "bernoulli", n.trees=6000, shrinkage=0.02,</span></span>
<span><span class="co">#                 interaction.depth=3)</span></span>
<span><span class="co"># saveRDS(gbm.data, file.choose())</span></span>
<span><span class="va">gbm.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">'https://github.com/Tripartio/ale/raw/main/download/gbm.data_model.rds'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gbm.data</span></span>
<span><span class="co">#&gt; gbm(formula = higher_income ~ ., distribution = "bernoulli", </span></span>
<span><span class="co">#&gt;     data = data[, -c(3, 4)], n.trees = 6000, interaction.depth = 3, </span></span>
<span><span class="co">#&gt;     shrinkage = 0.02)</span></span>
<span><span class="co">#&gt; A gradient boosted model with bernoulli loss function.</span></span>
<span><span class="co">#&gt; 6000 iterations were performed.</span></span>
<span><span class="co">#&gt; There were 12 predictors of which 12 had non-zero influence.</span></span></code></pre></div>
<div class="section level3">
<h3 id="aleplot-code-1">ALEPlot code<a class="anchor" aria-label="anchor" href="#aleplot-code-1"></a>
</h3>
<p>As before, we create a custom prediction function and then call the
<code>{ALEPlot}</code> function to generate the plots. The prediction
type here is “link”, which represents the log odds in the
<code>gbm</code> package.</p>
<p>Creation of the ALE plots here is rather slow because the
<code>gbm</code> predict function is slow. In this example, only
<code>age</code>, <code>education_num</code> (number of years of
education), and <code>hours_per_week</code> are plotted, along with the
interaction between <code>age</code> and
<code>hours_per_week</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Define the predictive function; note the additional arguments for the</span></span>
<span><span class="co">## predict function in gbm</span></span>
<span><span class="va">yhat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X.model</span>, <span class="va">newdata</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">X.model</span>, <span class="va">newdata</span>,</span>
<span>n.trees <span class="op">=</span> <span class="fl">6000</span>, type<span class="op">=</span><span class="st">"link"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Calculate and plot the ALE main and interaction effects for x_1, x_3,</span></span>
<span><span class="co">## x_11, and {x_1, x_11}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">ALE.1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">15</span><span class="op">)</span><span class="op">]</span>, <span class="va">gbm.data</span>, pred.fun<span class="op">=</span><span class="va">yhat</span>, J<span class="op">=</span><span class="fl">1</span>, K<span class="op">=</span><span class="fl">500</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ALE.3</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">15</span><span class="op">)</span><span class="op">]</span>, <span class="va">gbm.data</span>, pred.fun<span class="op">=</span><span class="va">yhat</span>, J<span class="op">=</span><span class="fl">3</span>, K<span class="op">=</span><span class="fl">500</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ALE.11</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">15</span><span class="op">)</span><span class="op">]</span>, <span class="va">gbm.data</span>, pred.fun<span class="op">=</span><span class="va">yhat</span>, J<span class="op">=</span><span class="fl">11</span>, K<span class="op">=</span><span class="fl">500</span>,</span>
<span>NA.plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ALE.1and11</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ALEPlot/man/ALEPlot.html" class="external-link">ALEPlot</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">15</span><span class="op">)</span><span class="op">]</span>, <span class="va">gbm.data</span>, pred.fun<span class="op">=</span><span class="va">yhat</span>, J<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span><span class="op">)</span>,</span>
<span>K<span class="op">=</span><span class="fl">50</span>, NA.plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ALEPlot%20gbm-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="ale-package-equivalent-1">
<code>{ale}</code> package equivalent<a class="anchor" aria-label="anchor" href="#ale-package-equivalent-1"></a>
</h3>
<p>Here is the analogous code using the <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> package. In
this case, we also need to define a custom predict function because of
the particular <code>n.trees = 6000</code> argument. To speed things up,
we provide a pretrained <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> object. This is possible
because <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> returns objects with data and plots bundled
together with no side effects (like automatic printing of created
plots). (It is probably possible to similarly cache
<code>{ALEPlot}</code> ALE objects, but it is not quite as
straightforward.)</p>
<div class="section level4">
<h4 id="log-odds">Log odds<a class="anchor" aria-label="anchor" href="#log-odds"></a>
</h4>
<p>We display all the plots because it is easy to do so with the
<a href="https://github.com/Tripartio/ale" class="external-link">ale</a> package but we focus on <code>age</code>,
<code>education_num</code>, and <code>hours_per_week</code> for
comparison with ALEPlot. If the shapes of these plots look different, it
is because <a href="https://github.com/Tripartio/ale" class="external-link">ale</a> tries as much as possible to display plots
on the same y-axis coordinate scale for easy comparison across
plots.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Custom predict function that returns log odds</span></span>
<span><span class="va">yhat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>,  n.trees <span class="op">=</span> <span class="fl">6000</span>,</span>
<span>            type<span class="op">=</span><span class="st">"link"</span><span class="op">)</span>  <span class="co"># return log odds</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate ALE data for all variables</span></span>
<span></span>
<span><span class="co"># # To generate the code, uncomment the following lines.</span></span>
<span><span class="co"># # But it is slow, so this vignette loads a pre-created model object.</span></span>
<span><span class="co"># gbm_ale_link &lt;- ale(</span></span>
<span><span class="co">#   data[,-c(3,4)], gbm.data,</span></span>
<span><span class="co">#   pred_fun = yhat,</span></span>
<span><span class="co">#   x_intervals = 500,</span></span>
<span><span class="co">#   rug_sample_size = 600,  # technical issue: rug_sample_size must be &gt; x_intervals + 1</span></span>
<span><span class="co">#   relative_y = 'zero',  # compatibility with ALEPlot</span></span>
<span><span class="co">#   model_packages = 'gbm'  # required for parallel processing</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># saveRDS(gbm_ale_link, file.choose())</span></span>
<span><span class="va">gbm_ale_link</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">'https://github.com/Tripartio/ale/raw/main/download/gbm_ale_link.rds'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print plots</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">gbm_ale_link</span><span class="op">$</span><span class="va">plots</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ale%20one-way%20link-1.png" width="672"></p>
<p>Now we generate ALE data for all two-way interactions and then plot
them. Again, note the interaction between <code>age</code> and
<code>hours_per_week</code>. The interaction is minimal except for the
extremely high cases of hours per week.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># # To generate the code, uncomment the following lines.</span></span>
<span><span class="co"># # But it is slow, so this vignette loads a pre-created model object.</span></span>
<span><span class="co"># gbm_ale_ixn_link &lt;- ale_ixn(</span></span>
<span><span class="co">#   data[,-c(3,4)], gbm.data,</span></span>
<span><span class="co">#   pred_fun = yhat,</span></span>
<span><span class="co">#   x_intervals = 500,</span></span>
<span><span class="co">#   rug_sample_size = 600,  # technical issue: rug_sample_size must be &gt; x_intervals + 1</span></span>
<span><span class="co">#   relative_y = 'zero',  # compatibility with ALEPlot</span></span>
<span><span class="co">#   model_packages = 'gbm'  # required for parallel processing</span></span>
<span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># saveRDS(gbm_ale_ixn_link, file.choose())</span></span>
<span><span class="va">gbm_ale_ixn_link</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">'https://github.com/Tripartio/ale/raw/main/download/gbm_ale_ixn_link.rds'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print plots</span></span>
<span><span class="va">gbm_ale_ixn_link</span><span class="op">$</span><span class="va">plots</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">walk</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">.x1</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># extract list of x1 ALE outputs</span></span>
<span>    <span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">.x1</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="co"># plot all x1 interaction plots</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ale%20ixn%20link-1.png" width="672"><img src="ale-ALEPlot_files/figure-html/ale%20ixn%20link-2.png" width="672"><img src="ale-ALEPlot_files/figure-html/ale%20ixn%20link-3.png" width="672"><img src="ale-ALEPlot_files/figure-html/ale%20ixn%20link-4.png" width="672"></p>
<p>In some of these plots, we can see some white spots. These are the
interaction zones where there is no data in the dataset to calculate the
existence of an interaction. For example, let’s focus on the
interactions of <code>age</code> with <code>education_num</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gbm_ale_ixn_link</span><span class="op">[[</span><span class="st">"plots"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"age"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"education_num"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ale%20age%20x%20education_num-1.png" width="700"></p>
<p>Here, the grey zones in the majority of the plot indicate that there
are minimal interaction effects for most of the data range. However, in
the small interacting zone of people younger than 30 years old or so
with 14 to 16 years of education, we see that the likelihood of higher
income is around 0.9 times lower than average. For the several white
zones, there is no data in the dataset to support an estimate. For
example, there is no one 35 to 45 years old with 15 years of education
and there is no one 49 to 60 years old with 14 years of education; so,
the model can say nothing about such interactions.</p>
</div>
<div class="section level4">
<h4 id="predicted-probabilities">Predicted probabilities<a class="anchor" aria-label="anchor" href="#predicted-probabilities"></a>
</h4>
<p>Log odds are not necessarily the most interpretable way to express
probabilities (though we will show shortly that they are sometimes
uniquely valuable). So, we repeat the ALE creation using the “response”
prediction type for probabilities and the default median centring of the
plots.</p>
<p>As we can see, the shapes of the plots are similar, but the y axes
are more easily interpretable as the probability (from 0 to 1) that a
census respondent is in the higher income category. The median of around
10% or so indicates the median prediction of the GBM model: half of the
respondents were predicted to have higher than a 10% likelihood of being
higher income and half were predicted to have lower likelihood. The
y-axis rug plots indicate that the predictions were generally rather
extreme, either relatively close to 0 or 1, with few predictions in the
middle.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Custom predict function that returns predicted probabilities</span></span>
<span><span class="va">yhat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>,  n.trees <span class="op">=</span> <span class="fl">6000</span>,</span>
<span>            type<span class="op">=</span><span class="st">"response"</span><span class="op">)</span>  <span class="co"># return predicted probabilities</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate ALE data for all variables</span></span>
<span></span>
<span><span class="co"># # To generate the code, uncomment the following lines.</span></span>
<span><span class="co"># # But it is slow, so this vignette loads a pre-created model object.</span></span>
<span><span class="co"># gbm_ale_prob &lt;- ale(</span></span>
<span><span class="co">#   data[,-c(3,4)], gbm.data,</span></span>
<span><span class="co">#   pred_fun = yhat,</span></span>
<span><span class="co">#   x_intervals = 500,</span></span>
<span><span class="co">#   rug_sample_size = 600,  # technical issue: rug_sample_size must be &gt; x_intervals + 1</span></span>
<span><span class="co">#   model_packages = 'nnet'  # required for parallel processing</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># saveRDS(gbm_ale_prob, file.choose())</span></span>
<span><span class="va">gbm_ale_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">'https://github.com/Tripartio/ale/raw/main/download/gbm_ale_prob.rds'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print plots</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">gbm_ale_prob</span><span class="op">$</span><span class="va">plots</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ale%20one-way%20prob-1.png" width="672"></p>
<p>Finally, we again generate two-way interactions, this time based on
probabilities instead of on log odds. However, probabilities might not
be the best choice for indicating interactions because, as we see from
the rugs in the one-way ALE plots, the GBM model heavily concentrates
its probabilities in the extremes near 0 and 1. Thus, the plots’
suggestions of strong interactions are likely exaggerated. In this case,
the log odds ALEs shown above are probably more relevant.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># # To generate the code, uncomment the following lines.</span></span>
<span><span class="co"># # But it is slow, so this vignette loads a pre-created model object.</span></span>
<span><span class="co"># gbm_ale_ixn_prob &lt;- ale_ixn(</span></span>
<span><span class="co">#   data[,-c(3,4)], gbm.data,</span></span>
<span><span class="co">#   pred_fun = yhat,</span></span>
<span><span class="co">#   x_intervals = 500,</span></span>
<span><span class="co">#   rug_sample_size = 600,  # technical issue: rug_sample_size must be &gt; x_intervals + 1</span></span>
<span><span class="co">#  model_packages = 'gbm'  # required for parallel processing</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># saveRDS(gbm_ale_ixn_prob, file.choose())</span></span>
<span><span class="va">gbm_ale_ixn_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">'https://github.com/Tripartio/ale/raw/main/download/gbm_ale_ixn_prob.rds'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print plots</span></span>
<span><span class="va">gbm_ale_ixn_prob</span><span class="op">$</span><span class="va">plots</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">walk</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">.x1</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># extract list of x1 ALE outputs</span></span>
<span>    <span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">.x1</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="co"># plot all x1 plots</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-ALEPlot_files/figure-html/ale%20ixn%20prob-1.png" width="672"><img src="ale-ALEPlot_files/figure-html/ale%20ixn%20prob-2.png" width="672"><img src="ale-ALEPlot_files/figure-html/ale%20ixn%20prob-3.png" width="672"><img src="ale-ALEPlot_files/figure-html/ale%20ixn%20prob-4.png" width="672"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Chitu Okoli.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
