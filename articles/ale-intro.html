<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ale">
<title>Introduction to the `ale` package • ale</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to the `ale` package">
<meta property="og:description" content="ale">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ale</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.20231101</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/ale-ALEPlot.html">Comparison between `ALEPlot` and `ale` packages</a>
    <a class="dropdown-item" href="../articles/ale-intro.html">Introduction to the `ale` package</a>
    <a class="dropdown-item" href="../articles/ale-small-datasets.html">Analyzing small datasets (&lt;2000 rows) with ALE</a>
    <a class="dropdown-item" href="../articles/ale-statistics.html">ALE-based statistics for statistical inference and effect sizes</a>
    <a class="dropdown-item" href="../articles/ale-x-datatypes.html">ale function handling of various datatypes for x</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Tripartio/ale/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Introduction to the `ale` package</h1>
                        <h4 data-toc-skip class="author">Chitu
Okoli</h4>
            
            <h4 data-toc-skip class="date">2024-01-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Tripartio/ale/blob/HEAD/vignettes/ale-intro.Rmd" class="external-link"><code>vignettes/ale-intro.Rmd</code></a></small>
      <div class="d-none name"><code>ale-intro.Rmd</code></div>
    </div>

    
    
<p>Accumulated Local Effects (ALE) were initially developed as a <a href="https://www.doi.org/10.1111/rssb.12377" title="Apley, Daniel W., and Jingyu Zhu. 'Visualizing the effects of predictor variables in black box supervised learning models.' Journal of the Royal Statistical Society Series B: Statistical Methodology 82.4 (2020): 1059-1086" class="external-link">model-agnostic
approach for global explanations of the results of black-box machine
learning algorithms</a>. ALE has at least two primary advantages over
other approaches like partial dependency plots (PDP) and SHapley
Additive exPlanations (SHAP): its values are not affected by the
presence of interactions among variables in a model and its computation
is relatively rapid. This package rewrites the original code from the
‘ALEPlot’ package for calculating ALE data and it completely
reimplements the plotting of ALE values. It also extends the original
ALE concept to add bootstrap-based confidence intervals and ALE-based
statistics that can be used for statistical inference.</p>
<p>For more details, see Okoli, Chitu. 2023. “Statistical Inference
Using Machine Learning and Classical Techniques Based on Accumulated
Local Effects (ALE).” arXiv. <a href="https://doi.org/10.48550/arXiv.2310.09877" class="external-link uri">https://doi.org/10.48550/arXiv.2310.09877</a>.</p>
<p>This vignette demonstrates the basic functionality of the
<code>ale</code> package on standard large datasets used for machine
learning. A separate vignette is devoted to its use on <a href="ale-small-datasets.html" title="ale package for small datasets">small datasets</a>, as is often
the case with statistical inference. (How small is small? That’s a tough
question, but as that vignette explains, most datasets of less than 2000
rows are probably “small” and even many datasets that are more than 2000
rows are nonetheless “small”.) Other vignettes introduce <a href="ale-statistics.html">ALE-based statistics for statistical
inference</a>, show how the <code>ale</code> package handles <a href="ale-x-datatypes.html">various datatypes of input variables</a>,
and <a href="ale-ALEPlot.html">compares the <code>ale</code> package
with the reference <code>ALEPlot</code> package</a>.</p>
<div class="section level2">
<h2 id="diamonds-dataset">diamonds dataset<a class="anchor" aria-label="anchor" href="#diamonds-dataset"></a>
</h2>
<p>For this introduction, we use the <code>diamonds</code> dataset,
built-in with the <code>ggplot2</code> graphics system. We cleaned the
original version by <a href="https://lorentzen.ch/index.php/2021/04/16/a-curious-fact-on-the-diamonds-dataset/" title="errors in the diamonds dataset" class="external-link">removing duplicates</a> and
invalid entries where the length (x), width (y), or depth (z) is 0.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clean up some invalid entries</span></span>
<span><span class="va">diamonds</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html" class="external-link">diamonds</a></span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">y</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">z</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># https://lorentzen.ch/index.php/2021/04/16/a-curious-fact-on-the-diamonds-dataset/</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">price</span>, <span class="va">carat</span>, <span class="va">cut</span>, <span class="va">color</span>, <span class="va">clarity</span>,</span>
<span>    .keep_all <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    x_length <span class="op">=</span> <span class="va">x</span>,</span>
<span>    y_width <span class="op">=</span> <span class="va">y</span>,</span>
<span>    z_depth <span class="op">=</span> <span class="va">z</span>,</span>
<span>    depth_pct <span class="op">=</span> <span class="va">depth</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span></span>
<span><span class="co">#&gt;      carat               cut        color       clarity       depth_pct    </span></span>
<span><span class="co">#&gt;  Min.   :0.2000   Fair     : 1492   D:4658   SI1    :9857   Min.   :43.00  </span></span>
<span><span class="co">#&gt;  1st Qu.:0.5200   Good     : 4173   E:6684   VS2    :8227   1st Qu.:61.00  </span></span>
<span><span class="co">#&gt;  Median :0.8500   Very Good: 9714   F:6998   SI2    :7916   Median :61.80  </span></span>
<span><span class="co">#&gt;  Mean   :0.9033   Premium  : 9657   G:7815   VS1    :6007   Mean   :61.74  </span></span>
<span><span class="co">#&gt;  3rd Qu.:1.1500   Ideal    :14703   H:6443   VVS2   :3463   3rd Qu.:62.60  </span></span>
<span><span class="co">#&gt;  Max.   :5.0100                     I:4556   VVS1   :2413   Max.   :79.00  </span></span>
<span><span class="co">#&gt;                                     J:2585   (Other):1856                  </span></span>
<span><span class="co">#&gt;      table           price          x_length         y_width      </span></span>
<span><span class="co">#&gt;  Min.   :43.00   Min.   :  326   Min.   : 3.730   Min.   : 3.680  </span></span>
<span><span class="co">#&gt;  1st Qu.:56.00   1st Qu.: 1410   1st Qu.: 5.160   1st Qu.: 5.170  </span></span>
<span><span class="co">#&gt;  Median :57.00   Median : 3365   Median : 6.040   Median : 6.040  </span></span>
<span><span class="co">#&gt;  Mean   :57.58   Mean   : 4686   Mean   : 6.009   Mean   : 6.012  </span></span>
<span><span class="co">#&gt;  3rd Qu.:59.00   3rd Qu.: 6406   3rd Qu.: 6.730   3rd Qu.: 6.720  </span></span>
<span><span class="co">#&gt;  Max.   :95.00   Max.   :18823   Max.   :10.740   Max.   :58.900  </span></span>
<span><span class="co">#&gt;                                                                   </span></span>
<span><span class="co">#&gt;     z_depth      </span></span>
<span><span class="co">#&gt;  Min.   : 1.070  </span></span>
<span><span class="co">#&gt;  1st Qu.: 3.190  </span></span>
<span><span class="co">#&gt;  Median : 3.740  </span></span>
<span><span class="co">#&gt;  Mean   : 3.711  </span></span>
<span><span class="co">#&gt;  3rd Qu.: 4.150  </span></span>
<span><span class="co">#&gt;  Max.   :31.800  </span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>Here is the description of the modified dataset.</p>
<table class="table">
<colgroup>
<col width="23%">
<col width="76%">
</colgroup>
<thead><tr class="header">
<th>Variable</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>price</td>
<td>price in US dollars ($326–$18,823)</td>
</tr>
<tr class="even">
<td>carat</td>
<td>weight of the diamond (0.2–5.01)</td>
</tr>
<tr class="odd">
<td>cut</td>
<td>quality of the cut (Fair, Good, Very Good, Premium, Ideal)</td>
</tr>
<tr class="even">
<td>color</td>
<td>diamond color, from D (best) to J (worst)</td>
</tr>
<tr class="odd">
<td>clarity</td>
<td>a measurement of how clear the diamond is (I1 (worst), SI2, SI1,
VS2, VS1, VVS2, VVS1, IF (best))</td>
</tr>
<tr class="even">
<td>x_length</td>
<td>length in mm (0–10.74)</td>
</tr>
<tr class="odd">
<td>y_width</td>
<td>width in mm (0–58.9)</td>
</tr>
<tr class="even">
<td>z_depth</td>
<td>depth in mm (0–31.8)</td>
</tr>
<tr class="odd">
<td>depth_pct</td>
<td>total depth percentage = z / mean(x, y) = 2 * z / (x + y)
(43–79)</td>
</tr>
<tr class="even">
<td>table</td>
<td>width of top of diamond relative to widest point (43–95)</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span></span>
<span><span class="co">#&gt; tibble [39,739 × 10] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;  $ carat    : num [1:39739] 0.23 0.21 0.23 0.29 0.31 0.24 0.24 0.26 0.22 0.23 ...</span></span>
<span><span class="co">#&gt;  $ cut      : Ord.factor w/ 5 levels "Fair"&lt;"Good"&lt;..: 5 4 2 4 2 3 3 3 1 3 ...</span></span>
<span><span class="co">#&gt;  $ color    : Ord.factor w/ 7 levels "D"&lt;"E"&lt;"F"&lt;"G"&lt;..: 2 2 2 6 7 7 6 5 2 5 ...</span></span>
<span><span class="co">#&gt;  $ clarity  : Ord.factor w/ 8 levels "I1"&lt;"SI2"&lt;"SI1"&lt;..: 2 3 5 4 2 6 7 3 4 5 ...</span></span>
<span><span class="co">#&gt;  $ depth_pct: num [1:39739] 61.5 59.8 56.9 62.4 63.3 62.8 62.3 61.9 65.1 59.4 ...</span></span>
<span><span class="co">#&gt;  $ table    : num [1:39739] 55 61 65 58 58 57 57 55 61 61 ...</span></span>
<span><span class="co">#&gt;  $ price    : int [1:39739] 326 326 327 334 335 336 336 337 337 338 ...</span></span>
<span><span class="co">#&gt;  $ x_length : num [1:39739] 3.95 3.89 4.05 4.2 4.34 3.94 3.95 4.07 3.87 4 ...</span></span>
<span><span class="co">#&gt;  $ y_width  : num [1:39739] 3.98 3.84 4.07 4.23 4.35 3.96 3.98 4.11 3.78 4.05 ...</span></span>
<span><span class="co">#&gt;  $ z_depth  : num [1:39739] 2.43 2.31 2.31 2.63 2.75 2.48 2.47 2.53 2.49 2.39 ...</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">$</span><span class="va">price</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     326    1410    3365    4686    6406   18823</span></span></code></pre></div>
<p>For machine learning analysis that intends to extrapolate its results
to future data, We must first split the dataset into training and test
samples. The model is developed on the training set and then evaluated
on the test set. (When a dataset is too small to feasibly split into
training and test sets, then the ale package has tools to appropriately
handle such <a href="ale-small-datasets.html" title="ale package for small datasets">small datasets</a>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Split the dataset into training and test sets</span></span>
<span><span class="co"># https://stackoverflow.com/a/54892459/2449926</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">train_test_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diamonds_train</span> <span class="op">&lt;-</span> <span class="va">diamonds</span><span class="op">[</span><span class="va">train_test_split</span>, <span class="op">]</span></span>
<span><span class="va">diamonds_test</span> <span class="op">&lt;-</span> <span class="va">diamonds</span><span class="op">[</span><span class="op">!</span><span class="va">train_test_split</span>, <span class="op">]</span></span></code></pre></div>
<p>So, now we split the dataset with an 80-20 split for a training set
of 31,841 rows and a test set of 7,898 rows. Now we can build our
model.</p>
</div>
<div class="section level2">
<h2 id="modelling-with-general-additive-models-gam">Modelling with general additive models (GAM)<a class="anchor" aria-label="anchor" href="#modelling-with-general-additive-models-gam"></a>
</h2>
<p>ALE is a model-agnostic IML approach, that is, it works with any kind
of machine learning model. As such, the <code>ale</code> works with any
R model with the only condition that it can predict numeric outcomes
(such as raw estimates for regression and probabilities or odds ratios
for classification). For this demonstration, we will use general
additive models (GAM), a relatively fast algorithm that models data more
flexibly than ordinary least squares regression. It is beyond our scope
here to explain how GAM works (you can learn more with <a href="https://noamross.github.io/gams-in-r-course/chapter1/" title="Tutorial on GAM" class="external-link">Noam Ross’s excellent tutorial</a>), but the
examples here will work with any machine learning algorithm.</p>
<p>We train a GAM model to predict diamond prices:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a GAM model with flexible curves to predict diamond prices.</span></span>
<span><span class="co"># (In testing, mgcv::gam actually performed better than nnet.)</span></span>
<span><span class="co"># Smooth all numeric variables and include all other variables</span></span>
<span><span class="co"># Build model on training data, not on the full dataset.</span></span>
<span><span class="va">gam_diamonds</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">price</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">carat</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth_pct</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">table</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">x_length</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">y_width</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">z_depth</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">cut</span> <span class="op">+</span> <span class="va">color</span> <span class="op">+</span> <span class="va">clarity</span>,</span>
<span>  data <span class="op">=</span> <span class="va">diamonds_train</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">gam_diamonds</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: gaussian </span></span>
<span><span class="co">#&gt; Link function: identity </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; price ~ s(carat) + s(depth_pct) + s(table) + s(x_length) + s(y_width) + </span></span>
<span><span class="co">#&gt;     s(z_depth) + cut + color + clarity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;               Estimate Std. Error  t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  4413.8270    14.6887  300.490  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; cut.L         282.9005    42.6670    6.630 3.40e-11 ***</span></span>
<span><span class="co">#&gt; cut.Q           0.5949    29.9527    0.020 0.984153    </span></span>
<span><span class="co">#&gt; cut.C          59.0119    22.1652    2.662 0.007763 ** </span></span>
<span><span class="co">#&gt; cut^4          38.5756    15.9970    2.411 0.015896 *  </span></span>
<span><span class="co">#&gt; color.L     -2154.1921    21.2064 -101.582  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; color.Q      -698.0122    19.4190  -35.945  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; color.C       -66.5582    18.2415   -3.649 0.000264 ***</span></span>
<span><span class="co">#&gt; color^4        75.6030    17.0393    4.437 9.15e-06 ***</span></span>
<span><span class="co">#&gt; color^5      -116.1725    16.1289   -7.203 6.03e-13 ***</span></span>
<span><span class="co">#&gt; color^6       -46.9826    15.0328   -3.125 0.001778 ** </span></span>
<span><span class="co">#&gt; clarity.L    4174.5052    37.6891  110.762  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; clarity.Q   -1571.3435    35.1359  -44.722  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; clarity.C     807.3063    30.3669   26.585  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; clarity^4    -253.7668    24.6400  -10.299  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; clarity^5     211.8216    20.4734   10.346  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; clarity^6      37.3081    18.0393    2.068 0.038633 *  </span></span>
<span><span class="co">#&gt; clarity^7     129.6810    15.9079    8.152 3.71e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                edf Ref.df       F p-value    </span></span>
<span><span class="co">#&gt; s(carat)     8.083  8.748  21.871  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(depth_pct) 6.924  7.869   7.081  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(table)     4.035  5.061   2.620  0.0199 *  </span></span>
<span><span class="co">#&gt; s(x_length)  7.284  8.023  39.995  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(y_width)   8.679  8.878 153.594  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(z_depth)   8.675  8.868  10.990  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.929   Deviance explained = 92.9%</span></span>
<span><span class="co">#&gt; GCV = 1.2564e+06  Scale est. = 1.254e+06  n = 31841</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="ale-function-for-generating-ale-data-and-plots">
<code>ale</code> function for generating ALE data and plots<a class="anchor" aria-label="anchor" href="#ale-function-for-generating-ale-data-and-plots"></a>
</h2>
<p>The core function in the <code>ale</code> package is the
<code>ale</code> function. Consistent with tidyverse conventions, its
first argument is a dataset. Its second argument is a model object–any R
model object that can generate numeric predictions is acceptable. By
default, it generates ALE data and plots on all the input variables used
for the model. To change these options (e.g., to calculate ALE for only
a subset of variables; to output the data only or the plots only rather
than both; or to use a custom, non-standard predict function for the
model), see details in the help file for the function:
<code><a href="../reference/ale.html">help(ale)</a></code>.</p>
<p>The <code>ale</code> function returns a list with various elements.
The two main ones are <code>data</code>, containing the ALE x intervals
and the y values for each interval, and <code>plots</code>, containing
the ALE plots as individual <code>ggplot</code> objects. Each of these
elements is a list with one element per input variable. The function
also returns several details about the outcome (y) variable and
important parameters that were used for the ALE calculation. Another
important element is <code>stats</code>, containing ALE-based
statistics, which we describe in <a href="ale-statistics.html" title="ALE-based statistics">a separate vignette</a>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simple ALE without bootstrapping</span></span>
<span><span class="va">ale_gam_diamonds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ale.html">ale</a></span><span class="op">(</span><span class="va">diamonds_test</span>, <span class="va">gam_diamonds</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating ALE <span style="color: #00BB00;">■                               </span>   0% |  ETA: ?</span></span>
<span><span class="co">#&gt; Calculating ALE <span style="color: #00BB00;">■■■■■■■■■■■■■■■■■■              </span>  56% |  ETA:  2s</span></span></code></pre></div>
<p>To access the plot for a specific variable, we can call it by its
variable name as an element of the <code>plots</code> element. These are
<code>ggplot</code> objects, so they are easy to manipulate. For
example, to access and print the <code>carat</code> ALE plot, we simply
call <code>ale_gam_diamonds$plots$carat</code> :</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print a plot by entering its reference</span></span>
<span><span class="va">ale_gam_diamonds</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">carat</span></span></code></pre></div>
<p><img src="ale-intro_files/figure-html/print%20carat-1.png" width="384"></p>
<p>To iterate the list and plot all the ALE plots, we provide here some
demonstration code using the <code>gridExtra</code> package for
arranging multiple plots in a common plot grid using
<code><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">gridExtra::grid.arrange</a></code>. We need to pass the list of plots
to the <code>grobs</code> argument and we can specify that we want two
plots per row with the <code>ncol</code> argument.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print all plots</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">ale_gam_diamonds</span><span class="op">$</span><span class="va">plots</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-intro_files/figure-html/print%20ale_simple-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="bootstrapped-ale">Bootstrapped ALE<a class="anchor" aria-label="anchor" href="#bootstrapped-ale"></a>
</h2>
<p>One of the key features of the ALE package is bootstrapping of the
ALE results to ensure that the results are reliable, that is,
generalizable to data beyond the sample on which the model was built.
Such external generalization requires analyzing the <code>ale</code>
function on test data distinct from the training data. When samples are
too small for this, we provide a different bootstrapping method,
<code>model_bootstrap</code>, explained in the vignette for <a href="ale-small-datasets.html" title="ale package for small datasets">small datasets</a>.</p>
<p>Although ALE is faster than most other IML techniques for global
explanation such as partial dependence plots (PDP) and SHAP, it still
requires some time to run. Bootstrapping multiplies that time by the
number of bootstrap iterations. Since this vignette is just a
demonstration of package functionality rather than a real analysis, we
will demonstrate bootstrapping on a small subset of the test data. This
will run much faster as the speed of the ALE algorithm depends on the
size of the dataset. So, let us take a random sample of 200 rows of the
test set.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bootstraping is rather slow, so create a smaller subset of new data for demonstration</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">new_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diamonds_test</span><span class="op">)</span>, <span class="fl">200</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">diamonds_small_test</span> <span class="op">&lt;-</span> <span class="va">diamonds_test</span><span class="op">[</span><span class="va">new_rows</span>, <span class="op">]</span></span></code></pre></div>
<p>Now we create bootstrapped ALE data and plots using the
<code>boot_it</code> argument. ALE is a relatively stable IML algorithm
(compared to others like PDP), so 100 bootstrap samples should be
sufficient for relatively stable results, especially for model
development. Final results could be confirmed with 1000 bootstrap
samples or more, but there should not be much difference in the results
beyond 100 iterations. However, so that this introduction runs faster,
we demonstrate it here with only 10 iterations.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Normally boot_it should be set to 100, but just 10 here for a faster demonstration</span></span>
<span><span class="va">ale_gam_diamonds_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ale.html">ale</a></span><span class="op">(</span><span class="va">diamonds_small_test</span>, <span class="va">gam_diamonds</span>, boot_it <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating ALE <span style="color: #00BB00;">■                               </span>   0% |  ETA: ?</span></span>
<span><span class="co">#&gt; Calculating ALE <span style="color: #00BB00;">■■■■■■■■■■■■■■                  </span>  44% |  ETA:  2s</span></span>
<span></span>
<span><span class="co"># Bootstrapping produces confidence intervals</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">ale_gam_diamonds_boot</span><span class="op">$</span><span class="va">plots</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-intro_files/figure-html/ale_boot-1.png" width="672"></p>
<p>In this case, the bootstrapped results are mostly similar to single
(non-bootstrapped) ALE result. In principle, we should always bootstrap
the results and trust only in bootstrapped results. The most unusual
result is that values of <code>x_length</code> (the length of the
diamond) from 6.2 mm or so and higher are associated with lower diamond
prices. When we compare this with the <code>y_width</code> value (width
of the diamond), we suspect that when both the length and width (that
is, the size) of a diamond become increasingly large, the price
increases so much more rapidly with the width than with the length that
the width has an inordinately high effect that is tempered by a
decreased effect of the length at those high values. This would be worth
further exploration for real analysis, but here we are just introducing
the key features of the package.</p>
</div>
<div class="section level2">
<h2 id="ale-interactions">ALE interactions<a class="anchor" aria-label="anchor" href="#ale-interactions"></a>
</h2>
<p>Another advantage of ALE is that it provides data for two-way
interactions between variables. This is implemented with the
<code><a href="../reference/ale_ixn.html">ale::ale_ixn</a></code> function. Like the <code>ale</code> function,
<code>ale_ixn</code> similarly requires an input dataset and a model
object. By default, it generates ALE data and plots on all possible
pairs of input variables used for the model. However, an ALE interaction
requires at least one of the variables to be numeric. So,
<code>ale_ixn</code> has a notion of x1 and x2 variables; the x1
variable must be numeric whereas the x2 can be of any input datatype. To
change the default options (e.g., to calculate interactions for only
certain pairs of variables), see details in the help file for the
function: <code><a href="../reference/ale_ixn.html">help(ale_ixn)</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ALE two-way interactions</span></span>
<span><span class="va">ale_ixn_gam_diamonds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ale_ixn.html">ale_ixn</a></span><span class="op">(</span><span class="va">diamonds_test</span>, <span class="va">gam_diamonds</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating ALE interactions <span style="color: #00BB00;">■                               </span>   0% |  ETA: ?</span></span>
<span><span class="co">#&gt; Calculating ALE interactions <span style="color: #00BB00;">■■■■■■                          </span>  17% |  ETA: 21s</span></span>
<span><span class="co">#&gt; Calculating ALE interactions <span style="color: #00BB00;">■■■■■■■■■■■                     </span>  33% |  ETA: 15s</span></span>
<span><span class="co">#&gt; Calculating ALE interactions <span style="color: #00BB00;">■■■■■■■■■■■■■■■■                </span>  50% |  ETA: 10s</span></span>
<span><span class="co">#&gt; Calculating ALE interactions <span style="color: #00BB00;">■■■■■■■■■■■■■■■■■■■■■           </span>  67% |  ETA:  6s</span></span></code></pre></div>
<p>Like the <code>ale</code> function, the <code>ale_ixn</code> returns
a list with one element per input x1 variable, as well as a
<code>.common_data</code> element with details about the outcome (y)
variable. However, in this case, each variable’s element consists of a
list of all the x2 variables for which the x1 interaction is calculated.
Each x2 element then has two elements: the ALE data for that variable
and a <code>ggplot</code> plot object that plots that ALE data. In the
interaction plots, the x1 variable is always shown on the x axis and the
x2 variable on the y axis.</p>
<p>Again, we provide here some demonstration code to plot all the ALE
plots. It is a little more complex this time because of the two levels
of interacting variables in the output data, so we use the
<code>purrr</code> package to iterate the list structure.
<code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::walk</a></code> takes a list as its first argument and then we
specify an anonymous function for what we want to do with each element
of the list. We specify the anonymous function as
<code>\(.x1) {...}</code> where <code>.x1</code> in our case represents
each individual element of <code>ale_ixn_gam_diamonds$plots</code> in
turn, that is, a sublist of plots with which the x1 variable interacts.
We print the plots of all the x1 interactions as a combined grid of
plots with <code><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">gridExtra::grid.arrange</a></code>, as before.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print all interaction plots</span></span>
<span><span class="va">ale_ixn_gam_diamonds</span><span class="op">$</span><span class="va">plots</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">walk</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">.x1</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># extract list of x1 ALE outputs</span></span>
<span>    <span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">.x1</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="co"># plot each x1 plot</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><img src="ale-intro_files/figure-html/print%20all%20ale_ixn-1.png" width="672"><img src="ale-intro_files/figure-html/print%20all%20ale_ixn-2.png" width="672"><img src="ale-intro_files/figure-html/print%20all%20ale_ixn-3.png" width="672"><img src="ale-intro_files/figure-html/print%20all%20ale_ixn-4.png" width="672"><img src="ale-intro_files/figure-html/print%20all%20ale_ixn-5.png" width="672"></p>
<p>Because we are printing all plots together with the same
<code><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">gridExtra::grid.arrange</a></code> statement, some of them might
appear vertically distorted because each plot is forced to be of the
same height. For more fine-tuned presentation, we would need to refer to
a specific plot. For example, we can print the interaction plot between
carat and depth by referring to it thus:
<code>ale_ixn_gam_diamonds$plots$carat$depth</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ale_ixn_gam_diamonds</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">carat</span><span class="op">$</span><span class="va">depth</span></span></code></pre></div>
<p><img src="ale-intro_files/figure-html/print%20specific%20ixn-1.png" width="480"></p>
<p>This is not the best dataset to use to illustrate ALE interactions
because there are none here. This is expressed in the graphs by the ALE
y values all falling in the middle grey band (the median band), which
indicates that any interactions would not shift the price outside the
middle 5% of its values. In other words, there is no meaningful
interaction effect.</p>
<p>Note that ALE interactions are very particular: an ALE interaction
means that two variables have a composite effect over and above their
separate independent effects. So, of course <code>x_length</code> and
<code>y_width</code> both have effects on the price, as the one-way ALE
plots show, but they have no additional composite effect. To see what
ALE interaction plots look like in the presence of interactions, see the
<a href="ale-ALEPlot.html">ALEPlot comparison vignette</a>, which
explains the interaction plots in more detail.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Chitu Okoli.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
