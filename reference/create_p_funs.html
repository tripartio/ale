<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Calculating p-values is not trivial for ALE statistics because ALE is
non-parametric and model-agnostic. Because ALE is non-parametric (that is,
it does not assume any particular distribution of data), the ale package
generates p-values by calculating ALE for many random variables; this makes the
procedure somewhat slow. For this reason, they are not calculated by default;
they must be explicitly requested. Because the ale package is model-agnostic (that is, it
works with any kind of R model), the ale() function cannot always automatically
manipulate the model object to create the p-values. It can only do so for
models that follow the standard R statistical modelling conventions, which
includes almost all built-in R algorithms (like stats::lm() and stats::glm()) and many widely
used statistics packages (like mgcv and survival), but which excludes most
machine learning algorithms (like tidymodels and caret). For non-standard
algorithms, the user needs to do a little work to help the ale function
correctly manipulate its model object."><title>Create a p-value functions object that can be used to generate p-values — create_p_funs • ale</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Create a p-value functions object that can be used to generate p-values — create_p_funs"><meta property="og:description" content="Calculating p-values is not trivial for ALE statistics because ALE is
non-parametric and model-agnostic. Because ALE is non-parametric (that is,
it does not assume any particular distribution of data), the ale package
generates p-values by calculating ALE for many random variables; this makes the
procedure somewhat slow. For this reason, they are not calculated by default;
they must be explicitly requested. Because the ale package is model-agnostic (that is, it
works with any kind of R model), the ale() function cannot always automatically
manipulate the model object to create the p-values. It can only do so for
models that follow the standard R statistical modelling conventions, which
includes almost all built-in R algorithms (like stats::lm() and stats::glm()) and many widely
used statistics packages (like mgcv and survival), but which excludes most
machine learning algorithms (like tidymodels and caret). For non-standard
algorithms, the user needs to do a little work to help the ale function
correctly manipulate its model object."><meta property="og:image" content="https://tripartio.github.io/ale/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ale</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.20240206</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/ale-intro.html">Introduction to the ale package</a>
    <a class="dropdown-item" href="../articles/ale-small-datasets.html">Analyzing small datasets (fewer than 2000 rows) with ALE</a>
    <a class="dropdown-item" href="../articles/ale-statistics.html">ALE-based statistics for statistical inference and effect sizes</a>
    <a class="dropdown-item" href="../articles/ale-x-datatypes.html">ale function handling of various datatypes for x</a>
    <a class="dropdown-item" href="../articles/ale-ALEPlot.html">Comparison between ALEPlot and ale packages</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Tripartio/ale/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Create a p-value functions object that can be used to generate p-values</h1>
      <small class="dont-index">Source: <a href="https://github.com/Tripartio/ale/blob/HEAD/R/stats.R" class="external-link"><code>R/stats.R</code></a></small>
      <div class="d-none name"><code>create_p_funs.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Calculating p-values is not trivial for ALE statistics because ALE is
non-parametric and model-agnostic. Because ALE is non-parametric (that is,
it does not assume any particular distribution of data), the <code>ale</code> package
generates p-values by calculating ALE for many random variables; this makes the
procedure somewhat slow. For this reason, they are not calculated by default;
they must be explicitly requested. Because the <code>ale</code> package is model-agnostic (that is, it
works with any kind of R model), the <code><a href="ale.html">ale()</a></code> function cannot always automatically
manipulate the model object to create the p-values. It can only do so for
models that follow the standard R statistical modelling conventions, which
includes almost all built-in R algorithms (like <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm()</a></code> and <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm()</a></code>) and many widely
used statistics packages (like <code>mgcv</code> and <code>survival</code>), but which excludes most
machine learning algorithms (like <code>tidymodels</code> and <code>caret</code>). For non-standard
algorithms, the user needs to do a little work to help the ale function
correctly manipulate its model object.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">create_p_funs</span><span class="op">(</span></span>
<span>  <span class="va">training_data</span>,</span>
<span>  <span class="va">test_data</span>,</span>
<span>  <span class="va">model</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  parallel <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>  model_packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>  random_model_call_string <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  random_model_call_string_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  y_col <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  pred_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">type</span> <span class="op">=</span> <span class="va">pred_type</span><span class="op">)</span> <span class="op">{</span></span>
<span>     <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span>object <span class="op">=</span></span>
<span>    <span class="va">object</span>, newdata <span class="op">=</span> <span class="va">newdata</span>, type <span class="op">=</span> <span class="va">type</span><span class="op">)</span></span>
<span> <span class="op">}</span>,</span>
<span>  pred_type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>  rand_it <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  silent <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  .testing_mode <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>training_data</dt>
<dd><p>dataframe. The dataset originally used to train <code>model</code>.
See details and also documentation for <code><a href="ale.html">ale()</a></code>.</p></dd>


<dt>test_data</dt>
<dd><p>dataframe. The dataset that will be used to create ALE data.
See details.</p></dd>


<dt>model</dt>
<dd><p>model object. The model used to train the original <code>training_data</code>.
for which ALE should be calculated. See details and also documentation for <code><a href="ale.html">ale()</a></code>.</p></dd>


<dt>...</dt>
<dd><p>not used. Inserted to require explicit naming of subsequent arguments.</p></dd>


<dt>parallel</dt>
<dd><p>See documentation for <code><a href="ale.html">ale()</a></code></p></dd>


<dt>model_packages</dt>
<dd><p>See documentation for <code><a href="ale.html">ale()</a></code></p></dd>


<dt>random_model_call_string</dt>
<dd><p>character string. If NULL, <code>create_p_funs()</code> tries to
automatically detect and construct the call for p-values. If it cannot, the
function will fail early. In that case, a character string of the full call
for the model must be provided that includes the random variable. See details.</p></dd>


<dt>random_model_call_string_vars</dt>
<dd><p>See documentation for <code>model_call_string_vars</code>
in <code><a href="model_bootstrap.html">model_bootstrap()</a></code>; the operation is very similar.</p></dd>


<dt>y_col</dt>
<dd><p>See documentation for <code><a href="ale.html">ale()</a></code></p></dd>


<dt>pred_fun, pred_type</dt>
<dd><p>See documentation for <code><a href="ale.html">ale()</a></code>.</p></dd>


<dt>rand_it</dt>
<dd><p>non-negative integer length 1. Number of times that the model
should be retrained with a new random variable. The default of 1000 should
give reasonably stable p-values. It can be reduced as low as 100 for faster
test runs.</p></dd>


<dt>silent</dt>
<dd><p>See documentation for <code><a href="ale.html">ale()</a></code></p></dd>


<dt>.testing_mode</dt>
<dd><p>logical. Internal use only.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>The return value is a list of class <code>c('p_funs', 'ale', 'list'</code>) with an
<code>ale_version</code> attribute whose value is the version of the <code>ale</code> package used to
create the object. See examples for an illustration of how to inspect this list.
Its elements are:</p><ul><li><p><code>value_to_p</code>: a list of functions named for each each available ALE statistic.
Each function signature is <code>function(x)</code> where x is a numeric. The function returns
the p-value (minimum 0; maximum 1) for the respective statistic based on the random variable analysis.
For an input x that returns p, its interpretation is that p% of random variables
obtained the same or higher statistic value. For example, to get the p-value
of a NALED of 4.2, enter <code>p_funs$value_to_p(4.2)</code>. A return value of 0.03 means
that only 3% of random variables obtained a NALED greater than or equal to 4.2.</p></li>
<li><p><code>p_to_random_value</code>: a list of functions named for each each available ALE statistic.
These are the inverse functions of <code>value_to_p</code>. The signature is <code>function(p)</code>
where p is a numeric from 0 to 1. The function returns the numeric value of the
random variable statistic that would yield the provided p-value.
For an input p that returns x, its interpretation is that p% of random variables
obtained the same or higher statistic value. For example, to get the random
variable ALED for the 0.05 p-value, enter <code>p_funs$p_to_random_value(0.05)</code>.
A return value of 102 means that only 5% of random variables obtained an ALED
greater than or equal to 102.</p></li>
<li><p><code>rand_stats</code>: a tibble whose rows are each of the <code>rand_it</code> iterations of the
random variable analysis and whose columns are the ALE statistics obtained for
each random variable.</p></li>
<li><p><code>residuals</code>: the actual <code>y_col</code> values from <code>training_data</code> minus the predicted
values from the <code>model</code> (without random variables) on the <code>training_data</code>.
<code>residual_distribution</code>: the closest estimated distribution for the <code>residuals</code>
as determined by <code><a href="https://jonasmoss.github.io/univariateML/reference/MaximumLikelihoodDistribution.html" class="external-link">univariateML::rml()</a></code>. This is the distribution used to generate
all the random variables.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="approach-to-calculating-p-values">Approach to calculating p-values<a class="anchor" aria-label="anchor" href="#approach-to-calculating-p-values"></a></h2>
    

<p>The <code>ale</code> package takes a literal frequentist approach to the calculation of
p-values. That is, it literally retrains the model 1000 times, each time
modifying it by adding a distinct random variable to the model.
(The number of iterations is customizable
with the <code>rand_it</code> argument.) The ALEs and ALE statistics are calculated for
each random variable. The percentiles of the distribution of these
random-variable ALEs are then used to determine p-values for non-random variables.
Thus, p-values are interpreted as the frequency of random variable ALE statistics
that exceed the value of ALE statistic of the actual variable in question.
The specific steps are as follows:</p><ul><li><p>The residuals of the original model trained on the training data are calculated
(residuals are the actual y target value minus the predicted values).</p></li>
<li><p>The closest distribution of the residuals is detected with
<code><a href="https://jonasmoss.github.io/univariateML/reference/model_select.html" class="external-link">univariateML::model_select()</a></code>.</p></li>
<li><p>1000 new models are trained by generating a random variable each time with
<code><a href="https://jonasmoss.github.io/univariateML/reference/MaximumLikelihoodDistribution.html" class="external-link">univariateML::rml()</a></code> and then training a new model with that random variable
added.</p></li>
<li><p>The ALEs and ALE statistics are calculated for each random variable.</p></li>
<li><p>For each ALE statistic, the empirical cumulative distribution function
(from <code><a href="https://rdrr.io/r/stats/ecdf.html" class="external-link">stats::ecdf()</a></code>) is used to create a function to determine p-values
according to the distribution of the random variables' ALE statistics.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="datasets">Datasets<a class="anchor" aria-label="anchor" href="#datasets"></a></h2>
    

<p>Because the <code>ale</code> package takes a literal frequentist approach to the
calculation of p-values, the precision of the p-values depends on correctly
representing the modelling workflow. Specifically, models should be trained
on a training subset and ALE statistics should be calculated on a test subset.
Thus, the random variables should be trained on the same training subset and
their ALE statistics should be calculated on the same test subset. Thus the
model takes both <code>training_data</code> and <code>test_data</code> as distinct arguments. If,
for whatever reason, the ALE is calculated on the same dataset as is used to
train the model, then the same dataset should be entered for both
<code>training_data</code> and <code>test_data</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Okoli, Chitu. 2023.
“Statistical Inference Using Machine Learning and Classical Techniques Based
on Accumulated Local Effects (ALE).” arXiv. <a href="https://arxiv.org/abs/2310.09877" class="external-link">https://arxiv.org/abs/2310.09877</a>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># Sample 1000 rows from the diamonds dataset (for a simple example)diamonds</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">diamonds_sample</span> <span class="op">&lt;-</span> <span class="va">diamonds</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span>, <span class="fl">1000</span><span class="op">)</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Split the dataset into training and test sets</span></span></span>
<span class="r-in"><span><span class="co"># https://stackoverflow.com/a/54892459/2449926</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">train_test_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diamonds_sample</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">diamonds_train</span> <span class="op">&lt;-</span> <span class="va">diamonds_sample</span><span class="op">[</span><span class="va">train_test_split</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">diamonds_test</span> <span class="op">&lt;-</span> <span class="va">diamonds_sample</span><span class="op">[</span><span class="op">!</span><span class="va">train_test_split</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create a GAM model with flexible curves to predict diamond price</span></span></span>
<span class="r-in"><span><span class="co"># Smooth all numeric variables and include all other variables</span></span></span>
<span class="r-in"><span><span class="co"># Build model on training data, not on the full dataset.</span></span></span>
<span class="r-in"><span><span class="va">gam_diamonds</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">price</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">carat</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">table</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>    <span class="va">cut</span> <span class="op">+</span> <span class="va">color</span> <span class="op">+</span> <span class="va">clarity</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">diamonds_train</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">gam_diamonds</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Family: gaussian </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Link function: identity </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Formula:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> price ~ s(carat) + s(depth) + s(table) + s(x) + s(y) + s(z) + </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cut + color + clarity</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Parametric coefficients:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)  3311.6596    82.3642  40.208  &lt; 2e-16 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cut.L         226.8516   174.6866   1.299  0.19447    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cut.Q         154.4894   136.7646   1.130  0.25900    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cut.C         -72.0299   114.5065  -0.629  0.52951    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cut^4          63.4426    91.1593   0.696  0.48667    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> color.L     -1748.6107   119.8822 -14.586  &lt; 2e-16 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> color.Q      -499.5061   109.9114  -4.545 6.41e-06 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> color.C        -7.7188   102.4915  -0.075  0.93999    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> color^4       132.4433    95.3721   1.389  0.16533    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> color^5      -261.4225    89.7563  -2.913  0.00369 ** </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> color^6        34.2734    81.9067   0.418  0.67574    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> clarity.L    4464.0110   271.7651  16.426  &lt; 2e-16 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> clarity.Q   -3168.1893   261.5197 -12.115  &lt; 2e-16 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> clarity.C    1276.9741   215.1091   5.936 4.44e-09 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> clarity^4    -983.6948   161.9254  -6.075 1.97e-09 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> clarity^5     557.2408   120.8123   4.612 4.67e-06 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> clarity^6    -117.3182   100.4726  -1.168  0.24331    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> clarity^7      -0.9172    87.9078  -0.010  0.99168    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Approximate significance of smooth terms:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            edf Ref.df     F  p-value    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(carat) 8.507  8.820 3.423 0.000389 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(depth) 1.273  1.510 0.061 0.901571    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(table) 5.707  6.842 1.522 0.207715    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x)     5.006  6.125 4.761 8.88e-05 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(y)     5.644  6.755 9.317  &lt; 2e-16 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(z)     2.516  3.307 1.128 0.335376    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> R-sq.(adj) =  0.942   Deviance explained = 94.5%</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GCV = 9.5069e+05  Scale est. = 8.9531e+05  n = 801</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create p-value functions</span></span></span>
<span class="r-in"><span><span class="va">pf_diamonds</span> <span class="op">&lt;-</span> <span class="fu">create_p_funs</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">diamonds_train</span>,</span></span>
<span class="r-in"><span>  <span class="va">diamonds_test</span>,</span></span>
<span class="r-in"><span>  <span class="va">gam_diamonds</span>,</span></span>
<span class="r-in"><span>  <span class="co"># only 100 iterations for a quick demo; but usually should remain at 1000</span></span></span>
<span class="r-in"><span>  rand_it <span class="op">=</span> <span class="fl">100</span>,</span></span>
<span class="r-in"><span>  model_packages <span class="op">=</span> <span class="st">'mgcv'</span>,  <span class="co"># required for parallel processing</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Examine the structure of the returned object</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pf_diamonds</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> List of 5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ value_to_p           :List of 6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aled     :function (x)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aler_min :function (x)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aler_max :function (x)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naled    :function (x)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naler_min:function (x)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naler_max:function (x)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ p_to_random_value    :List of 6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aled     :function (p)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aler_min :function (p)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aler_max :function (p)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naled    :function (p)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naler_min:function (p)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naler_max:function (p)  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ rand_stats           : tibble [100 × 6] (S3: tbl_df/tbl/data.frame)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aled     : num [1:100] 25.58 11.85 6.25 30.87 16.93 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aler_min : num [1:100] -180.2 -57.9 -17.1 -124.9 -98 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ aler_max : num [1:100] 122 42.5 28.5 214.6 171.4 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naled    : num [1:100] 0.3208 0.1385 0.0401 0.3853 0.2162 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naler_min: num [1:100] -2.868 -1.122 -0.374 -1.995 -1.87 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ naler_max: num [1:100] 0.873 0.249 0.249 1.621 1.247 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ residuals            : num [1:801(1d)] -1180.2 -1096.3 -216.6 -25.6 -1511.5 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ residual_distribution: 'univariateML' Named num [1:4] 9.71 1020.87 2.99 1.24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "names")= chr [1:4] "mean" "sd" "nu" "xi"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "model")= chr "Skew Student-t"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "density")= chr "fGarch::dsstd"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "logLik")= num -6503</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "support")= num [1:2] -Inf Inf</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "n")= int 801</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "call")= language f(x = x, na.rm = na.rm)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "class")= chr [1:3] "p_funs" "ale" "list"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "ale_version")=Classes 'package_version', 'numeric_version'  hidden list of 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ : int [1:4] 0 2 0 20240206</span>
<span class="r-in"><span><span class="co"># In RStudio: View(pf_diamonds)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calculate ALEs with p-values</span></span></span>
<span class="r-in"><span><span class="va">ale_gam_diamonds</span> <span class="op">&lt;-</span> <span class="fu"><a href="ale.html">ale</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">diamonds_test</span>,</span></span>
<span class="r-in"><span>  <span class="va">gam_diamonds</span>,</span></span>
<span class="r-in"><span>  model_packages <span class="op">=</span> <span class="st">'mgcv'</span>,  <span class="co"># required for parallel processing</span></span></span>
<span class="r-in"><span>  p_values <span class="op">=</span> <span class="va">pf_diamonds</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in ale(diamonds_test, gam_diamonds, model_packages = "mgcv", p_values = pf_diamonds):</span> object 'diamonds_test' not found</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the ALE data. The horizontal bands in the plots use the p-values.</span></span></span>
<span class="r-in"><span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">ale_gam_diamonds</span><span class="op">$</span><span class="va">plots</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in eval(expr, envir, enclos):</span> object 'ale_gam_diamonds' not found</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Chitu Okoli.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

